<!DOCTYPE html>
  <html class ="page" lang="ru">
    <head>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>  CatEnergy </title>
      <link href="css/normalize.css" rel="stylesheet">
      <link rel ="preload" href="css/app.min.css" as="style">
      <link href="css/app.min.css" rel="stylesheet">
      <link rel ="preload" href="../../fonts/oswaldregular.woff2" as="font" crossorigin>
  </head>
  <body class="page__body">
    <div class = "body-wrapper" id = "container">
      <div class = "squares-wrapper" id = "squares-wrapper">
        <div class = "first-square" id = "first-square">
        </div>
        <div class = "second-square"  id = "second-square">
        </div>
      </div>
      <div class="instument-bar">
      </div>
    </div>
  </body>

    <script>
      const firstSquare = document.getElementById('first-square');
      const secondSquare = document.getElementById('second-square');
      const squaresWrapper = document.getElementById('squares-wrapper');
      const container = document.getElementById('container');
      let areSquaresBinded = false;
      let currentActiveSquare;
      let currentPassiveSquare;

      firstSquare.addEventListener('mousedown', function(e) {
        // if (!areSquaresBinded){
        //   currentActiveSquare = firstSquare;
        //   currentPassiveSquare = secondSquare;
        // }else{
        //   currentActiveSquare = squaresWrapper;
        // }
        currentActiveSquare = firstSquare;
        currentPassiveSquare = secondSquare;
        offsetX = e.clientX - firstSquare.getBoundingClientRect().left;
        offsetY = e.clientY - firstSquare.getBoundingClientRect().top;
      });

      secondSquare.addEventListener('mousedown', function(e) {
        // if (!areSquaresBinded){
        //   currentActiveSquare = secondSquare;
        //   currentPassiveSquare = firstSquare;
        // }else {
        //   currentActiveSquare = squaresWrapper;
        // }
        currentActiveSquare = secondSquare;
        currentPassiveSquare = firstSquare;
        offsetX = e.clientX - secondSquare.getBoundingClientRect().left;
        offsetY = e.clientY - secondSquare.getBoundingClientRect().top;
      });


      window.addEventListener('mousemove', function(e) {
        if (currentActiveSquare) {

          let newX = e.clientX - offsetX;
          let newY = e.clientY - offsetY;

          const containerRect = container.getBoundingClientRect();
          const draggableRect = currentActiveSquare.getBoundingClientRect();
          let passiveRect;
          if (!!currentPassiveSquare) passiveRect = currentPassiveSquare.getBoundingClientRect();

          const isSquareInLeftOfContainer = newX < containerRect.left || draggableRect.left < containerRect.left;
          const isSquareInRightOfContainer = newX + draggableRect.width > containerRect.right || draggableRect.right > containerRect.right;
          const isSquareInTopOfContainer = newY < containerRect.top || draggableRect.top < containerRect.top;
          const isSquareInBottomOfContainer = newY + draggableRect.height > containerRect.bottom || draggableRect.bottom > containerRect.bottom;
          const isSquareOutOfContainer =
            (isSquareInBottomOfContainer
              || isSquareInTopOfContainer
              || isSquareInRightOfContainer
              || isSquareInLeftOfContainer);

          const addTransitionToSquareStyle = () => {
            currentActiveSquare.style.transition = 'left 0.2s ease, top 0.2s ease';
            setTimeout(() => {currentActiveSquare.style.transition = ''}, 200);
          }

          const makeWrapperActive = () => {
            // console.log(`${parseInt(currentPassiveSquare.style.left)}-${parseInt(currentActiveSquare.style.left)}px`);
            // const currentPassiveLeft = currentPassiveSquare.left;
            // const currentPassiveTop = currentPassiveSquare.top;
            // squaresWrapper.top = currentActiveSquare.top;
            // squaresWrapper.left = currentActiveSquare.left;
            // currentActiveSquare = squaresWrapper;
            //



            // console.log(`${parseInt(currentPassiveSquare.style.left)}-${parseInt(currentActiveSquare.style.left)}px`)
            // currentPassiveSquare.style.left = `${parseInt(currentPassiveSquare.style.left)-parseInt(squaresWrapper.style.left)}px`;
          }

          if (!!passiveRect){
            // squaresWrapper.style.left = `${Math.min(parseInt(firstSquare.style.left), parseInt(secondSquare.style.left))}px`
            // squaresWrapper.style.top = `${Math.min(parseInt(firstSquare.style.top), parseInt(secondSquare.style.top))}px`
            // // console.log("width")
            // // console.log(`${draggableRect.left}`);
            // squaresWrapper.style.width = `${parseInt(draggableRect.left)+parseInt(passiveRect.right)}px`;
            // squaresWrapper.style.width = `${parseInt(currentActiveSquare.left)+parseInt(currentPassiveSquare.right)}px`;
            const isTopLeftInPassiveSquare = (
              passiveRect.left < newX
              & passiveRect.right > newX
              & passiveRect.top < newY
              & passiveRect.bottom > newY
            )
            const isTopRigthInPassiveSquare = (
              passiveRect.left < (newX + draggableRect.width)
              & passiveRect.right > (newX + draggableRect.width)
              & passiveRect.top < newY
              & passiveRect.bottom > newY
            )
            const isBottomRightInPassiveSquare = (
              passiveRect.left < (newX + draggableRect.width)
              & passiveRect.right > (newX + draggableRect.width)
              & passiveRect.top < (newY + draggableRect.height)
              & passiveRect.bottom > (newY + draggableRect.height)
            )
            const isBottomLeftInPassiveSquare = (
              passiveRect.left < newX
              & passiveRect.right > newX
              & passiveRect.top < (newY + draggableRect.height)
              & passiveRect.bottom > (newY + draggableRect.height)
            )

            const isSquareOutOfSquare =
              (!isBottomLeftInPassiveSquare
                && !isBottomRightInPassiveSquare
                && !isTopRigthInPassiveSquare
                && !isTopLeftInPassiveSquare);

            const isTopLeftCornerInRightOfPassiveSquare = (passiveRect.right - newX) < (passiveRect.bottom - newY);
            const isTopRightCornerInLeftOfPassiveSquare =
              ((newX + draggableRect.width) - passiveRect.left) < (passiveRect.bottom - newY);
            const isBottomRightCornerInTopOfPassiveSquare =
              ((newX + draggableRect.width) - passiveRect.left) > ((newY + draggableRect.height) - passiveRect.top);
            const isBottomLeftCornerInTopOfPassiveSquare =
              (passiveRect.top - (newY + draggableRect.height)) > (newX - passiveRect.right);

            const makeActiveSquareInTopOfPassive = () => {
              console.log("Make top!")
              newY = passiveRect.top - passiveRect.height - 1;
              // addTransitionToSquareStyle();
              makeWrapperActive();
              areSquaresBinded = true;
            };
            const makeActiveSquareInLeftOfPassive = () => {
              console.log("Make left!")
              newX = passiveRect.left - draggableRect.width - 1;
              addTransitionToSquareStyle();
            }
            const makeActiveSquareInBottomOfPassive = () => {
              console.log("Make bot!")
              newY = passiveRect.bottom + 1;
              addTransitionToSquareStyle();
            }
            const makeActiveSquareInRightOfPassive = () => {
              console.log("Make right!")
              newX = passiveRect.right + 1;
              addTransitionToSquareStyle();
            }

            if (isTopLeftInPassiveSquare){
              if ( isTopLeftCornerInRightOfPassiveSquare){
                makeActiveSquareInRightOfPassive()
              }else{
                makeActiveSquareInBottomOfPassive()
              }
            }

            if (isTopRigthInPassiveSquare){
              if ( isTopRightCornerInLeftOfPassiveSquare) {
                makeActiveSquareInLeftOfPassive()
              }else {
                makeActiveSquareInBottomOfPassive()
              }
            }

            if (isBottomRightInPassiveSquare){
              if (isBottomRightCornerInTopOfPassiveSquare){
                makeActiveSquareInTopOfPassive()
              }else{
                makeActiveSquareInLeftOfPassive()
              }
            }

            if (isBottomLeftInPassiveSquare){
              if (isBottomLeftCornerInTopOfPassiveSquare){
                makeActiveSquareInTopOfPassive()
              }else{
                makeActiveSquareInRightOfPassive()
              }
            }

            if (isSquareInTopOfContainer){
              makeActiveSquareInBottomOfPassive()
            }
            if (isSquareInLeftOfContainer){
              makeActiveSquareInRightOfPassive()
            }
            if (isSquareInRightOfContainer){
              makeActiveSquareInLeftOfPassive()
            }
            if (isSquareInBottomOfContainer) {
              makeActiveSquareInTopOfPassive()
            }
          }


          if (!currentActiveSquare !== squaresWrapper){
            if (isSquareInLeftOfContainer) newX = containerRect.left;
            if (isSquareInRightOfContainer) newX = containerRect.right - draggableRect.width;
            if (isSquareInTopOfContainer) newY = containerRect.top;
            if (isSquareInBottomOfContainer) newY = containerRect.bottom - draggableRect.height;
          }



          // if (currentActiveSquare !== squaresWrapper){
            currentActiveSquare.style.left = `${newX}px`;
            currentActiveSquare.style.top = `${newY}px`;

            if (areSquaresBinded){
              // currentPassiveSquare.style.left = `${parseInt(currentPassiveSquare.style.left) + offsetX}px`;
              // currentPassiveSquare.style.left = `${parseInt(currentPassiveSquare.style.top) + offsetY}px`;
              currentPassiveSquare.style.left = `${newX + 200}px`;
              currentPassiveSquare.style.left = `${newY + 200}px`;
            }

          // }else{
          //   currentActiveSquare.style.left = `${newX-193}px`;
          //   currentActiveSquare.style.top = `${newY-68}px`;
          // }


        }
      });


      // Окончание перетаскивания
      window.addEventListener('mouseup', function() {
          currentActiveSquare.style.transition = "";
          currentActiveSquare = null;
          currentPassiveSquare = null;
      });

    </script>

</html>
