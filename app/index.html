<!DOCTYPE html>
  <html class ="page" lang="ru">
    <head>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>  CatEnergy </title>
      <link href="css/normalize.css" rel="stylesheet">
      <link rel ="preload" href="css/app.min.css" as="style">
      <link href="css/app.min.css" rel="stylesheet">
      <link rel ="preload" href="../../fonts/oswaldregular.woff2" as="font" crossorigin>
  </head>
  <body class="page__body">
    <div class = "body-wrapper" id = "container">
      <div class = "squares-wrapper" id = "squares-wrapper">
        <div class = "first-square" id = "first-square">
        </div>
        <div class = "second-square"  id = "second-square">
        </div>
      </div>
      <div class="instument-bar">
      </div>
    </div>
  </body>

    <script>
      const firstSquare = document.getElementById('first-square');
      const secondSquare = document.getElementById('second-square');
      const squaresWrapper = document.getElementById('squares-wrapper');
      const container = document.getElementById('container');
      let areSquaresBinded = false;
      let areBindedInCurrentSession = false;
      let currentActiveSquare;
      let currentPassiveSquare;

      let activeOffsetX, activeOffsetY;

      let newX, newY;

      const makeWrapperActive = () => {
        console.log(`${parseInt(secondSquare.style.left) + parseInt(secondSquare.offsetWidth) - parseInt(firstSquare.style.left)}px`);
        if (parseInt(firstSquare.offsetLeft) < parseInt(secondSquare.offsetLeft)){
          squaresWrapper.style.width = `${parseInt(secondSquare.offsetLeft) + parseInt(secondSquare.offsetWidth) - parseInt(firstSquare.offsetLeft)}px`;
          squaresWrapper.style.left = `${firstSquare.offsetLeft}px`;
          newX = `${firstSquare.offsetLeft}px`;
          console.log(`squaresWrapper.offsetLeft ${squaresWrapper.offsetLeft}`)
          console.log("1")
        }else{
          squaresWrapper.style.width = `${parseInt(firstSquare.offsetLeft) + parseInt(firstSquare.offsetWidth) - parseInt(secondSquare.offsetLeft)}px`;
          squaresWrapper.style.left = `${secondSquare.offsetLeft}px`;
          console.log("2")
        }
        if (firstSquare.offsetTop < secondSquare.offsetTop){
          squaresWrapper.style.height = `${parseInt(secondSquare.offsetTop) + parseInt(secondSquare.offsetHeight) - parseInt(firstSquare.offsetTop)}px`;
          squaresWrapper.style.top = `${firstSquare.offsetLeft}px`;
          console.log("3")
        }else{
          squaresWrapper.style.height = `${parseInt(firstSquare.offsetTop) + parseInt(firstSquare.offsetHeight) - parseInt(secondSquare.offsetTop)}px`;
          squaresWrapper.style.top = `${secondSquare.offsetLeft}px`;
          console.log("4")
        }


        currentActiveSquare = squaresWrapper;
      }

      firstSquare.addEventListener('mousedown', function(e) {
        if (areSquaresBinded) {
          activeOffsetX = e.clientX - squaresWrapper.getBoundingClientRect().left;
          activeOffsetY = e.clientY - squaresWrapper.getBoundingClientRect().top;
          makeWrapperActive();
          return;
        }
        activeOffsetX = e.clientX - firstSquare.getBoundingClientRect().left;
        activeOffsetY = e.clientY - firstSquare.getBoundingClientRect().top;
        currentActiveSquare = firstSquare;
        currentPassiveSquare = secondSquare;

      });

      secondSquare.addEventListener('mousedown', function(e) {
        if (areSquaresBinded) {
          activeOffsetX = e.clientX - squaresWrapper.getBoundingClientRect().left;
          activeOffsetY = e.clientY - squaresWrapper.getBoundingClientRect().top;
          makeWrapperActive();
          return;
        }
        activeOffsetX = e.clientX - secondSquare.getBoundingClientRect().left;
        activeOffsetY = e.clientY - secondSquare.getBoundingClientRect().top;
        currentActiveSquare = secondSquare;
        currentPassiveSquare = firstSquare;

      });


      const checkBoundaries = (containerRect, square, dX, dY) => {
        const rect = square.getBoundingClientRect();

        const isSquareInLeftOfContainer = rect.left > containerRect.left;
        const isSquareInRightContainer = rect.right < containerRect.right;
        const isSquareInTopOfContainer = rect.top > containerRect.top;
        const isSquareInBottomOfContainer = rect.bottom < containerRect.bottom;

        if (!isSquareInLeftOfContainer && dX < 0) {
          square.style.left = `${containerRect.left}px`;
          return false;
        }
        if (!isSquareInRightContainer  && dX > 0) {
          square.style.left = `${containerRect.right - rect.width}px`;
          return false;
        }
        if (!isSquareInTopOfContainer && dY < 0) {
          square.style.top = `${containerRect.top}px`;
          return false;
        }
        if (!isSquareInBottomOfContainer && dY > 0) {
          square.style.top = `${containerRect.bottom - rect.height}px`;
          return false;
        }

        return true;
      }

      const checkCollision = () => {
        const activeRect = currentActiveSquare.getBoundingClientRect();
        const passiveRect = currentPassiveSquare.getBoundingClientRect();
        let isSquareInSquare = false;

        const makeActiveSquareInTopOfPassive = () => {
              console.log("Make top!")
              newY = passiveRect.top - passiveRect.height - 1;
              areSquaresBinded = true;
              isSquareInSquare = true;
        };
            const makeActiveSquareInLeftOfPassive = () => {
              console.log("Make left!")
              newX = passiveRect.left - activeRect.width - 1;
              areSquaresBinded = true;
              isSquareInSquare = true;
            }
            const makeActiveSquareInBottomOfPassive = () => {
              console.log("Make bot!")
              newY  = passiveRect.bottom + 1;
              areSquaresBinded = true;
              console.log(`active top ${newY} = passive bottom = ${passiveRect.bottom + 1}`);
              isSquareInSquare = true;
            }
            const makeActiveSquareInRightOfPassive = () => {
              console.log("Make right!")
              currentActiveSquare.style.left = `${passiveRect.right + 1}px`;
              console.log(passiveRect.right)
              console.log(currentActiveSquare.style.left)
              newX = passiveRect.right + 1;
              areSquaresBinded = true;
              isSquareInSquare = true;
            }

        const isTopLeftInPassiveSquare = (
          passiveRect.left <= activeRect.left
          & passiveRect.right >= activeRect.left
          & passiveRect.top <= activeRect.top
          & passiveRect.bottom >= activeRect.top
        )
        const isTopRightInPassiveSquare = (
          passiveRect.left <= (activeRect.right)
          & passiveRect.right >= (activeRect.right)
          & passiveRect.top <= activeRect.top
          & passiveRect.bottom >= activeRect.top
        )
        const isBottomRightInPassiveSquare = (
          passiveRect.left <= activeRect.right
          & passiveRect.right >= activeRect.right
          & passiveRect.top <= activeRect.bottom
          & passiveRect.bottom >= activeRect.bottom
        )
        const isBottomLeftInPassiveSquare = (
          passiveRect.left <= activeRect.left
          & passiveRect.right >= activeRect.left
          & passiveRect.top <= activeRect.bottom
          & passiveRect.bottom >= activeRect.bottom
        )

        const squaresAreTouched = isTopLeftInPassiveSquare
          || isTopRightInPassiveSquare
          || isBottomRightInPassiveSquare
          || isBottomLeftInPassiveSquare;


        const isTopLeftCornerInRightOfPassiveSquare =
          (passiveRect.right - activeRect.left) < (passiveRect.bottom - activeRect.top);
        const isTopRightCornerInLeftOfPassiveSquare =
          (activeRect.right - passiveRect.left) < (passiveRect.bottom - activeRect.top);
        const isBottomRightCornerInTopOfPassiveSquare =
          (activeRect.right - passiveRect.left) > (activeRect.bottom - passiveRect.top);
        const isBottomLeftCornerInTopOfPassiveSquare =
          (passiveRect.top - activeRect.bottom) > (activeRect.left - passiveRect.right);

        if (isTopLeftInPassiveSquare){
              if ( isTopLeftCornerInRightOfPassiveSquare){
                console.log("TopLeft to Right collision")
                makeActiveSquareInRightOfPassive()
              }else{
                makeActiveSquareInBottomOfPassive()
                console.log("TopLeft to bottom collision")
              }
            }

            if (isTopRightInPassiveSquare){
              if ( isTopRightCornerInLeftOfPassiveSquare) {
                makeActiveSquareInLeftOfPassive()
                console.log("TopRight to left collision")
              }else {
                makeActiveSquareInBottomOfPassive()
                console.log("TopRight to bottom collision")
              }
            }

            if (isBottomRightInPassiveSquare){
              if (isBottomRightCornerInTopOfPassiveSquare){
                makeActiveSquareInTopOfPassive()
                console.log("BottomRight to top collision")
              }else{
                makeActiveSquareInLeftOfPassive()
                console.log("BottomRight to left collision")
              }
            }

            if (isBottomLeftInPassiveSquare){
              if (isBottomLeftCornerInTopOfPassiveSquare){
                makeActiveSquareInTopOfPassive()
                console.log("BottomLeft to top collision")
              }else{
                makeActiveSquareInRightOfPassive()
                console.log("BottomRight to right collision")
              }
            }

        if (isSquareInSquare) {
          areSquaresBinded = true;
          makeWrapperActive();
          window.removeEventListener('mousemove', handleMouseMove);
          console.log("remove")
          areBindedInCurrentSession = true;
        }

        console.log(`isSquareInSquare ${isSquareInSquare}`);
            return isSquareInSquare;
      };

      function handleMouseMove (e){
        if (!currentActiveSquare) return;

        newX = e.clientX - activeOffsetX;
        newY = e.clientY - activeOffsetY;

        const containerRect = container.getBoundingClientRect();
        const activeRect = currentActiveSquare.getBoundingClientRect();
        let isPassiveSquareInContainer;

        let passiveRect;
        if (!!currentPassiveSquare) {
          passiveRect = currentPassiveSquare.getBoundingClientRect();
          isPassiveSquareInContainer = checkBoundaries(containerRect, currentPassiveSquare, e.movementX, e.movementY);
        }

        const isActiveSquareInContainer = checkBoundaries(containerRect, currentActiveSquare, e.movementX, e.movementY);

        if (!isActiveSquareInContainer) return;
        let isSquareInSquare;

        console.log(`Wrapper before check ${squaresWrapper.offsetLeft}`)
        if (!areSquaresBinded) {
          isSquareInSquare = checkCollision();
        }
        if (isSquareInSquare) return;
        console.log(`Wrapper after check ${squaresWrapper.offsetLeft}`)

        if (!isSquareInSquare){
          currentActiveSquare.style.left = `${newX}px`;
          currentActiveSquare.style.top = `${newY}px`;
        }
        console.log(`Wrapper after end ${squaresWrapper.offsetLeft}`)
      }

      window.addEventListener('mousemove', (e)=>handleMouseMove(e));

      window.addEventListener('mouseup', function() {
        // if (areBindedInCurrentSession) {
        //   squaresWrapper.style.left = "100px";
        // }
          currentActiveSquare = null;
          currentPassiveSquare = null;
          areBindedInCurrentSession = false;
      });

    </script>

</html>
