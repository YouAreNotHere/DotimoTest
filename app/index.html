<!DOCTYPE html>
  <html class ="page" lang="ru">
    <head>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>  CatEnergy </title>
      <link href="css/normalize.css" rel="stylesheet">
      <link rel ="preload" href="css/app.min.css" as="style">
      <link href="css/app.min.css" rel="stylesheet">
      <link rel ="preload" href="../../fonts/oswaldregular.woff2" as="font" crossorigin>
  </head>
  <body class="page__body">
    <div class = "body-wrapper" id = "container">
<!--      <div class = "squares-wrapper" id = "squares-wrapper">-->
        <div class = "first-square" id = "first-square">
        </div>
        <div class = "second-square"  id = "second-square">
        </div>
<!--      </div>-->
      <div class="instument-bar">
      </div>
    </div>
  </body>

    <script>
      const firstSquare = document.getElementById('first-square');
      const secondSquare = document.getElementById('second-square');
      const squaresWrapper = document.getElementById('squares-wrapper');
      const container = document.getElementById('container');
      let areSquaresBinded = false;
      let currentActiveSquare;
      let currentPassiveSquare;

      let activeOffsetX, activeOffsetY;

      let newX, newY;

      firstSquare.addEventListener('mousedown', function(e) {

        currentActiveSquare = firstSquare;
        currentPassiveSquare = secondSquare;

        activeOffsetX = e.clientX - firstSquare.getBoundingClientRect().left;
        activeOffsetY = e.clientY - firstSquare.getBoundingClientRect().top;

      });

      secondSquare.addEventListener('mousedown', function(e) {
        currentActiveSquare = secondSquare;
        currentPassiveSquare = firstSquare;

        activeOffsetX = e.clientX - secondSquare.getBoundingClientRect().left;
        activeOffsetY = e.clientY - secondSquare.getBoundingClientRect().top;

      });


      const checkBoundaries = (containerRect, square, dX, dY) => {
        const rect = square.getBoundingClientRect();
        // console.log('containerRect: ', containerRect.left)
        // console.log('rect.left: ', rect.left)

        const isSquareInLeftOfContainer = rect.left > containerRect.left;
        const isSquareInRightContainer = rect.right < containerRect.right;
        const isSquareInTopOfContainer = rect.top > containerRect.top;
        const isSquareInBottomOfContainer = rect.bottom < containerRect.bottom;

        if (!isSquareInLeftOfContainer && dX < 0) {
          square.style.left = `${containerRect.left}px`;
          return false;
        }
        if (!isSquareInRightContainer  && dX > 0) {
          square.style.left = `${containerRect.right - rect.width}px`;
          return false;
        }
        if (!isSquareInTopOfContainer && dY < 0) {
          square.style.top = `${containerRect.top}px`;
          return false;
        }
        if (!isSquareInBottomOfContainer && dY > 0) {
          square.style.top = `${containerRect.bottom - rect.height}px`;
          return false;
        }

        return true;
      }

      const checkCollision = () => {
        const activeRect = currentActiveSquare.getBoundingClientRect();
        const passiveRect = currentPassiveSquare.getBoundingClientRect();
        let isSquareInSquare = false;

        const makeActiveSquareInTopOfPassive = () => {
              console.log("Make top!")
              newY = passiveRect.top - passiveRect.height - 1;
              isSquareInSquare = true;
            };
            const makeActiveSquareInLeftOfPassive = () => {
              console.log("Make left!")
              newX = passiveRect.left - activeRect.width - 1;
              isSquareInSquare = true;
            }
            const makeActiveSquareInBottomOfPassive = () => {
              console.log("Make bot!")
              // currentActiveSquare.style.top  = passiveRect.bottom + 1;
              newY  = passiveRect.bottom + 1;
              isSquareInSquare = true;
              console.log(`active top ${newY} = passive bottom = ${passiveRect.bottom + 1}`)
            }
            const makeActiveSquareInRightOfPassive = () => {
              console.log("Make right!")
              // currentActiveSquare.style.left = passiveRect.right + 1;
              newX = passiveRect.right + 1;
              isSquareInSquare = true;
            }

        // const isTopLeftInPassiveSquare = (
        //   passiveRect.left < newX
        //   & passiveRect.right > newX
        //   & passiveRect.top < newY
        //   & passiveRect.bottom > newY
        // )

        const isTopLeftInPassiveSquare = (
          passiveRect.left < activeRect.left
          & passiveRect.right > activeRect.left
          & passiveRect.top < activeRect.top
          & passiveRect.bottom > activeRect.top
        )
        // const isTopRightInPassiveSquare = (
        //   passiveRect.left < (newX + activeRect.width)
        //   & passiveRect.right > (newX + activeRect.width)
        //   & passiveRect.top < newY
        //   & passiveRect.bottom > newY
        // )
        const isTopRightInPassiveSquare = (
          passiveRect.left < (activeRect.right)
          & passiveRect.right > (activeRect.right)
          & passiveRect.top < activeRect.top
          & passiveRect.bottom > activeRect.top
        )
        // const isBottomRightInPassiveSquare = (
        //   passiveRect.left < (newX + activeRect.width)
        //   & passiveRect.right > (newX + activeRect.width)
        //   & passiveRect.top < (newY + activeRect.height)
        //   & passiveRect.bottom > (newY + activeRect.height)
        // )
        const isBottomRightInPassiveSquare = (
          passiveRect.left < activeRect.right
          & passiveRect.right > activeRect.right
          & passiveRect.top < activeRect.bottom
          & passiveRect.bottom > activeRect.bottom
        )
        // const isBottomLeftInPassiveSquare = (
        //   passiveRect.left < newX
        //   & passiveRect.right > newX
        //   & passiveRect.top < (newY + activeRect.height)
        //   & passiveRect.bottom > (newY + activeRect.height)
        // )
        const isBottomLeftInPassiveSquare = (
          passiveRect.left < activeRect.left
          & passiveRect.right > activeRect.left
          & passiveRect.top < activeRect.bottom
          & passiveRect.bottom > activeRect.bottom
        )

        const squaresAreTouched = isTopLeftInPassiveSquare
          || isTopRightInPassiveSquare
          || isBottomRightInPassiveSquare
          || isBottomLeftInPassiveSquare;

        if (squaresAreTouched) {
          areSquaresBinded = true;
        }

        const isTopLeftCornerInRightOfPassiveSquare =
          (passiveRect.right - activeRect.left) < (passiveRect.bottom - activeRect.top);
        const isTopRightCornerInLeftOfPassiveSquare =
          (activeRect.right - passiveRect.left) < (passiveRect.bottom - activeRect.top);
        const isBottomRightCornerInTopOfPassiveSquare =
          (activeRect.right - passiveRect.left) > (activeRect.bottom - passiveRect.top);
        const isBottomLeftCornerInTopOfPassiveSquare =
          (passiveRect.top - activeRect.bottom) > (activeRect.left - passiveRect.right);

        if (isTopLeftInPassiveSquare){
              if ( isTopLeftCornerInRightOfPassiveSquare){
                console.log("TopLeft to Right collision")
                makeActiveSquareInRightOfPassive()
              }else{
                makeActiveSquareInBottomOfPassive()
                console.log("TopLeft to bottom collision")
                console.log(`passive right ${passiveRect.right} - newX ${newX} < passive bottom${passiveRect.bottom} - newY${newY}`)
              }
            }

            if (isTopRightInPassiveSquare){
              if ( isTopRightCornerInLeftOfPassiveSquare) {
                makeActiveSquareInLeftOfPassive()
                console.log("TopRight to left collision")
              }else {
                makeActiveSquareInBottomOfPassive()
                console.log("TopRight to bottom collision")
              }
            }

            if (isBottomRightInPassiveSquare){
              if (isBottomRightCornerInTopOfPassiveSquare){
                makeActiveSquareInTopOfPassive()
                console.log("BottomRight to top collision")
              }else{
                makeActiveSquareInLeftOfPassive()
                console.log("BottomRight to left collision")
              }
            }

            if (isBottomLeftInPassiveSquare){
              if (isBottomLeftCornerInTopOfPassiveSquare){
                makeActiveSquareInTopOfPassive()
                console.log("BottomLeft to top collision")
              }else{
                makeActiveSquareInRightOfPassive()
                console.log("BottomRight to right collision")
              }
            }

            return isSquareInSquare;
      };


      window.addEventListener('mousemove', function(e) {
        if (!currentActiveSquare) return;

        newX = e.clientX - activeOffsetX;
        newY = e.clientY - activeOffsetY;

        const containerRect = container.getBoundingClientRect();
        const activeRect = currentActiveSquare.getBoundingClientRect();

        let passiveRect;
        if (!!currentPassiveSquare) passiveRect = currentPassiveSquare.getBoundingClientRect();

        const isActiveSquareInContainer = checkBoundaries(containerRect, currentActiveSquare, e.movementX, e.movementY);
        const isPassiveSquareInContainer = checkBoundaries(containerRect, currentPassiveSquare, e.movementX, e.movementY);

        if (!isActiveSquareInContainer || (areSquaresBinded && !isPassiveSquareInContainer)) return;

        const isSquareInSquare = checkCollision();
        if (isSquareInSquare) {
          currentActiveSquare.style.left = `${newX}px`;
          currentActiveSquare.style.top = `${newY}px`;
          return;
        }

        currentActiveSquare.style.left = `${activeRect.left + e.movementX}px`;
        currentActiveSquare.style.top = `${activeRect.top + e.movementY}px`;

        if (areSquaresBinded) {
          currentPassiveSquare.style.left = `${passiveRect.left + e.movementX}px`;
          currentPassiveSquare.style.top = `${passiveRect.top + e.movementY}px`;
        }

      });


      // Окончание перетаскивания
      window.addEventListener('mouseup', function() {
          currentActiveSquare.style.transition = "";
          currentActiveSquare = null;
          currentPassiveSquare = null;
      });

    </script>

</html>
