<!DOCTYPE html>
  <html class ="page" lang="ru">
    <head>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>  Dotimo-test </title>
      <link href="css/normalize.css" rel="stylesheet">
      <link rel ="preload" href="css/app.min.css" as="style">
      <link href="css/app.min.css" rel="stylesheet">
      <link rel ="preload" href="../../fonts/oswaldregular.woff2" as="font" crossorigin>
  </head>
  <body class="page__body">
  <div class="container" id="container">
      <div class = "squares-wrapper" id = "squares-wrapper">
        <div class = "first-square" id = "first-square">
        </div>
        <div class = "second-square"  id = "second-square">
        </div>
      </div>
      <div class="instument-bar">
        <button class="bindSquares-button" id = "bindSquares-button" onclick="onclickHandler()">
          Join
        </button>
    </div>
  </div>
  </body>

    <script>
      const firstSquare = document.getElementById('first-square');
      const secondSquare = document.getElementById('second-square');
      const squaresWrapper = document.getElementById('squares-wrapper');
      const container = document.getElementById('container');

      let areSquaresBinded = false;
      let areBindedInCurrentSession = false;
      let currentActiveSquare;
      let currentPassiveSquare;
      let isActiveSquareInContainer;

      let activeOffsetX, activeOffsetY;

      let newX, newY;

      const onclickHandler = () => {
        areSquaresBinded = false;
        const oldSquareWrapperLeft = squaresWrapper.offsetLeft;
        const oldSquareWrapperTop = squaresWrapper.offsetTop;
        const oldSquareWrapperRight = squaresWrapper.offsetLeft + squaresWrapper.offsetWidth;
        const oldSquareWrapperBottom = squaresWrapper.offsetTop + squaresWrapper.offsetHeight;
        console.log(`oldSquareWrapperLeft ${oldSquareWrapperLeft}`)
        console.log(`oldSquareWrapperRight ${oldSquareWrapperRight}`)
        console.log(`oldSquareWrapperTop ${oldSquareWrapperTop}`)
        console.log(`oldSquareWrapperBottom ${oldSquareWrapperBottom}`)
        squaresWrapper.style.height = "100%";
        squaresWrapper.style.width = "100%";
        squaresWrapper.style.left = "0px";
        squaresWrapper.style.top = "0px";

        if (secondSquare.offsetTop < firstSquare.offsetTop){
          secondSquare.style.top = `${oldSquareWrapperTop - 5}px`
          firstSquare.style.top = `${oldSquareWrapperBottom - firstSquare.offsetHeight}px`
        }else{
          firstSquare.style.top = `${oldSquareWrapperTop - 5}px`
          secondSquare.style.top = `${oldSquareWrapperBottom - secondSquare.offsetHeight}px`
        }

        if (secondSquare.offsetLeft < firstSquare.offsetLeft){
          secondSquare.style.left = `${oldSquareWrapperLeft - 5}px`
          firstSquare.style.left = `${oldSquareWrapperRight - firstSquare.offsetWidth}px`
        }else{
          firstSquare.style.left = `${oldSquareWrapperLeft - 5}px`
          secondSquare.style.left = `${oldSquareWrapperRight - secondSquare.offsetWidth}px`
        }

        // if (secondSquare.offsetTop > (container.offsetTop + 5) && secondSquare.offsetTop < firstSquare.offsetTop){
        //   secondSquare.style.top = `${secondSquare.offsetTop - 5}px`
        //   console.log("1")
        // }else{
        //   firstSquare.style.top = `${firstSquare.offsetTop + 5}px`
        //   console.log("2")
        // }
        // if (secondSquare.offsetLeft > (container.offsetLeft + 5) && secondSquare.offsetLeft < firstSquare.offsetLeft){
        //   secondSquare.style.left = `${secondSquare.offsetLeft - 15}px`
        //   console.log("3")
        // }else{
        //   firstSquare.style.left = `${firstSquare.offsetLeft + 15}px`
        //   console.log("4")
        // }

        if (secondSquare.offsetTop > (container.offsetTop + firstSquare.offsetHeight + 5) ){
          if (secondSquare.offsetTop < firstSquare.offsetTop){
            secondSquare.style.top = `${secondSquare.offsetTop - 5}px`
            console.log("1.1")
          }else{
            firstSquare.style.top = `${firstSquare.offsetTop - 5}px`
            console.log("1.2")
          }
        }else{
          firstSquare.style.top = `${firstSquare.offsetTop + 5}px`
          console.log("2")
        }

        if (secondSquare.offsetLeft > (container.offsetLeft + firstSquare.offsetWidth + 5)){
          if (secondSquare.offsetLeft < firstSquare.offsetLeft){
            secondSquare.style.left = `${secondSquare.offsetLeft - 5}px`
            console.log("3.1")
          }else{
            firstSquare.style.left = `${firstSquare.offsetLeft + 5}`
            console.log("3.2")
          }

        }else{
          firstSquare.style.left = `${firstSquare.offsetLeft + 15}px`
          console.log("4")
        }
      }

      const makeWrapperActive = () => {
        const oldWrapperLeft = squaresWrapper.offsetLeft;
        const oldWrapperTop = squaresWrapper.offsetTop;

        const sumOfSquaresWidth = firstSquare.offsetWidth + secondSquare.offsetWidth;
        const sumOfSquaresHeight = firstSquare.offsetHeight + secondSquare.offsetHeight;

        const firstAndSecondTopDifferens = firstSquare.offsetTop - secondSquare.offsetTop;
        const secondAndSecondTopDifferens = secondSquare.offsetTop - firstSquare.offsetTop;

        const firstAndSecondLeftDifferens = firstSquare.offsetLeft - secondSquare.offsetLeft;
        const secondAndSecondLeftDifferens = secondSquare.offsetLeft - firstSquare.offsetLeft;

        currentActiveSquare = squaresWrapper;

        if(!areBindedInCurrentSession) return;

        if (parseInt(firstSquare.offsetLeft) < parseInt(secondSquare.offsetLeft)){
          squaresWrapper.style.width = `${parseInt(secondSquare.offsetLeft) + parseInt(secondSquare.offsetWidth) - parseInt(firstSquare.offsetLeft)}px`;
          squaresWrapper.style.left = `${firstSquare.offsetLeft}px`;
        }else{
          squaresWrapper.style.width = `${parseInt(firstSquare.offsetLeft) + parseInt(firstSquare.offsetWidth) - parseInt(secondSquare.offsetLeft)}px`;
          squaresWrapper.style.left = `${secondSquare.offsetLeft}px`;
        }
        if (firstSquare.offsetTop < secondSquare.offsetTop){
          squaresWrapper.style.height = `${parseInt(secondSquare.offsetTop) - parseInt(firstSquare.offsetTop) + parseInt(firstSquare.offsetHeight)}px`;
          squaresWrapper.style.top = `${firstSquare.offsetTop}px`;
        }else{
          squaresWrapper.style.height = `${parseInt(sumOfSquaresHeight) - (parseInt(secondSquare.offsetHeight)+parseInt(secondAndSecondTopDifferens))}px`;
          squaresWrapper.style.top = `${secondSquare.offsetTop}px`;
        }

        const squaresWrapperDx = (squaresWrapper.offsetLeft -oldWrapperLeft);
        const squaresWrapperDy = (squaresWrapper.offsetTop -oldWrapperTop);

        firstSquare.style.top = `${firstSquare.offsetTop - squaresWrapperDy}px`;
        firstSquare.style.left = `${firstSquare.offsetLeft - squaresWrapperDx}px`;
        secondSquare.style.top = `${secondSquare.offsetTop - squaresWrapperDy}px`;
        secondSquare.style.left = `${secondSquare.offsetLeft - squaresWrapperDx}px`;
      }

      firstSquare.addEventListener('mousedown', function(e) {
        if (areSquaresBinded) {
          activeOffsetX = e.clientX - squaresWrapper.getBoundingClientRect().left;
          activeOffsetY = e.clientY - squaresWrapper.getBoundingClientRect().top;
          makeWrapperActive();
          // console.log("In mouse down")
          console.dir(currentActiveSquare)
          return;
        }
        activeOffsetX = e.clientX - firstSquare.getBoundingClientRect().left;
        activeOffsetY = e.clientY - firstSquare.getBoundingClientRect().top;
        currentActiveSquare = firstSquare;
        currentPassiveSquare = secondSquare;
        console.log("In mouse down")
        console.dir(currentActiveSquare)
      });

      secondSquare.addEventListener('mousedown', function(e) {
        if (areSquaresBinded) {
          activeOffsetX = e.clientX - squaresWrapper.getBoundingClientRect().left;
          activeOffsetY = e.clientY - squaresWrapper.getBoundingClientRect().top;
          makeWrapperActive();
          console.log("In mouse down")
          console.dir(currentActiveSquare)
          return;
        }
        activeOffsetX = e.clientX - secondSquare.getBoundingClientRect().left;
        activeOffsetY = e.clientY - secondSquare.getBoundingClientRect().top;
        currentActiveSquare = secondSquare;
        currentPassiveSquare = firstSquare;
        console.log("In mouse down")
        console.dir(currentActiveSquare)
      });


      const checkBoundaries = (containerRect, square, dX, dY) => {
        const rect = square.getBoundingClientRect();

        const isSquareInLeftOfContainer = newX < (containerRect.left) || rect.left < containerRect.left;
        const isSquareInRightOfContainer = newX + rect.width > containerRect.right || rect.right > containerRect.right;
        const isSquareInTopOfContainer = newY < containerRect.top || rect.top < rect.top;
        const isSquareInBottomOfContainer = newY + rect.height > containerRect.bottom || rect.bottom > containerRect.bottom;
        const isSquareOutOfContainer =
          (isSquareInBottomOfContainer || isSquareInTopOfContainer || isSquareInRightOfContainer || isSquareInLeftOfContainer);

        if (isSquareInLeftOfContainer) {
          newX = 0;
        }
        if (isSquareInRightOfContainer) {
          newX = containerRect.right - rect.width - 20;
        }
        if (isSquareInTopOfContainer) {;
          newY = 0;
        }
        if (isSquareInBottomOfContainer) {
          newY = containerRect.bottom - rect.height - 20;
        }

        if (isSquareOutOfContainer) return false;

        isActiveSquareInContainer = true;
        return true;
      }

      const checkCollision = () => {
        const activeRect = currentActiveSquare.getBoundingClientRect();
        const passiveRect = currentPassiveSquare.getBoundingClientRect();
        let isSquareInSquare = false;

        const makeActiveSquareInTopOfPassive = () => {
              newY = passiveRect.top - passiveRect.height - 1;
              isSquareInSquare = true;
        };
            const makeActiveSquareInLeftOfPassive = () => {
              newX = passiveRect.left - activeRect.width - 1;
              isSquareInSquare = true;
            }
            const makeActiveSquareInBottomOfPassive = () => {
              newY  = passiveRect.bottom + 1;
              isSquareInSquare = true;
            }
            const makeActiveSquareInRightOfPassive = () => {
              newX = passiveRect.right + 1;
              isSquareInSquare = true;
            }

        const isTopLeftInPassiveSquare = (
          passiveRect.left <= activeRect.left
          & passiveRect.right >= activeRect.left
          & passiveRect.top <= activeRect.top
          & passiveRect.bottom >= activeRect.top
        )
        const isTopRightInPassiveSquare = (
          passiveRect.left <= (activeRect.right)
          & passiveRect.right >= (activeRect.right)
          & passiveRect.top <= activeRect.top
          & passiveRect.bottom >= activeRect.top
        )
        const isBottomRightInPassiveSquare = (
          passiveRect.left <= activeRect.right
          & passiveRect.right >= activeRect.right
          & passiveRect.top <= activeRect.bottom
          & passiveRect.bottom >= activeRect.bottom
        )
        const isBottomLeftInPassiveSquare = (
          passiveRect.left <= activeRect.left
          & passiveRect.right >= activeRect.left
          & passiveRect.top <= activeRect.bottom
          & passiveRect.bottom >= activeRect.bottom
        )

        const squaresAreTouched = isTopLeftInPassiveSquare
          || isTopRightInPassiveSquare
          || isBottomRightInPassiveSquare
          || isBottomLeftInPassiveSquare;


        const isTopLeftCornerInRightOfPassiveSquare =
          (passiveRect.right - activeRect.left) < (passiveRect.bottom - activeRect.top);
        const isTopRightCornerInLeftOfPassiveSquare =
          (activeRect.right - passiveRect.left) < (passiveRect.bottom - activeRect.top);
        const isBottomRightCornerInTopOfPassiveSquare =
          (activeRect.right - passiveRect.left) > (activeRect.bottom - passiveRect.top);
        const isBottomLeftCornerInTopOfPassiveSquare =
          (passiveRect.top - activeRect.bottom) > (activeRect.left - passiveRect.right);

        if (isTopLeftInPassiveSquare){
              if ( isTopLeftCornerInRightOfPassiveSquare){
                makeActiveSquareInRightOfPassive()
              }else{
                makeActiveSquareInBottomOfPassive()
              }
            }

            if (isTopRightInPassiveSquare){
              if ( isTopRightCornerInLeftOfPassiveSquare) {
                makeActiveSquareInLeftOfPassive()
              }else {
                makeActiveSquareInBottomOfPassive()
              }
            }

            if (isBottomRightInPassiveSquare){
              if (isBottomRightCornerInTopOfPassiveSquare){
                makeActiveSquareInTopOfPassive()
              }else{
                makeActiveSquareInLeftOfPassive()
              }
            }

            if (isBottomLeftInPassiveSquare){
              if (isBottomLeftCornerInTopOfPassiveSquare){
                makeActiveSquareInTopOfPassive()
              }else{
                makeActiveSquareInRightOfPassive()
              }
            }

        if (isSquareInSquare) {
          areSquaresBinded = true;
          areBindedInCurrentSession = true;
          makeWrapperActive();
        }

        console.log(`isSquareInSquare ${isSquareInSquare}`);
            return isSquareInSquare;
      };

      function handleMouseMove (e){
        if (!currentActiveSquare) return;
        // console.dir(currentActiveSquare);
        if (areBindedInCurrentSession) return;

        newX = e.clientX - activeOffsetX;
        newY = e.clientY - activeOffsetY;

        const containerRect = container.getBoundingClientRect();
        const activeRect = currentActiveSquare.getBoundingClientRect();
        let isPassiveSquareInContainer;

        let passiveRect;
        if (!!currentPassiveSquare) {
          passiveRect = currentPassiveSquare.getBoundingClientRect();
          isPassiveSquareInContainer = checkBoundaries(containerRect, currentPassiveSquare, e.movementX, e.movementY);
        }

        checkBoundaries(containerRect, currentActiveSquare, e.movementX, e.movementY);

        let isSquareInSquare = false;

        if (!areSquaresBinded) {
          isSquareInSquare = checkCollision();
        }

        if (isSquareInSquare) return;

        if (!isSquareInSquare){
          currentActiveSquare.style.left = `${newX}px`;
          currentActiveSquare.style.top = `${newY}px`;
        }
      }

      window.addEventListener('mousemove', (e) => handleMouseMove(e));

      window.addEventListener('mouseup', function() {
          currentActiveSquare = null;
          currentPassiveSquare = null;
          areBindedInCurrentSession = false;
      });

    </script>

</html>
